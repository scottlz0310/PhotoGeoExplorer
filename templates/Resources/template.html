<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Geo Preview</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""
          onerror="this.onerror=null; this.href='leaflet/leaflet.css';" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e1e1e;
            color: #cccccc;
        }

        .split-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        .image-pane {
            flex: 1;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #1e1e1e;
            position: relative;
            min-height: 100px;
        }

        .image-pane img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
        }

        .splitter {
            height: 4px;
            background: #007acc;
            cursor: ns-resize;
            position: relative;
            z-index: 10;
            flex-shrink: 0;
            display: {MAP_DISPLAY};
        }

        .splitter:hover {
            background: #1a9aff;
            height: 6px;
        }

        .splitter:active {
            background: #0098ff;
        }

        .map-pane {
            flex: 1;
            position: relative;
            min-height: 100px;
            display: {MAP_DISPLAY};
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .no-gps-message {
            display: {NO_GPS_DISPLAY};
            flex: 1;
            justify-content: center;
            align-items: center;
            background: #2d2d2d;
            color: #888;
            font-size: 14px;
            padding: 20px;
            text-align: center;
        }

        .no-gps-message p {
            margin: 10px 0;
        }

        .no-gps-message .icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }

        .loading.active {
            display: block;
        }

        .loading-spinner {
            border: 3px solid #333;
            border-top: 3px solid #007acc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰/ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ */
        @media (prefers-color-scheme: light) {
            body, html {
                background-color: #ffffff;
                color: #333333;
            }

            .image-pane {
                background: #f5f5f5;
            }

            .no-gps-message {
                background: #f0f0f0;
                color: #666;
            }
        }
    </style>
</head>
<body>
    <div class="split-container">
        <!-- ç”»åƒè¡¨ç¤ºãƒšã‚¤ãƒ³ -->
        <div class="image-pane" id="imagePane">
            <div class="loading active" id="loading">
                <div class="loading-spinner"></div>
            </div>
            <img id="photo" src="{IMAGE_PATH}" alt="Photo" onload="hideLoading()" onerror="handleImageError()">
        </div>

        <!-- ãƒªã‚µã‚¤ã‚ºå¯èƒ½ãªã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼ -->
        <div class="splitter" id="splitter"></div>

        <!-- åœ°å›³è¡¨ç¤ºãƒšã‚¤ãƒ³ -->
        <div class="map-pane">
            <div id="map"></div>
        </div>

        <!-- GPS ãƒ‡ãƒ¼ã‚¿ãªã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div class="no-gps-message">
            <div class="icon">ğŸ“</div>
            <p><strong>ä½ç½®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</strong></p>
            <p>ã“ã®ç”»åƒã«ã¯ GPS ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""
            onerror="this.onerror=null; this.src='leaflet/leaflet.js';"></script>
    <script>
        // è¨­å®š
        const LAT = {LAT};
        const LON = {LON};
        const HAS_GPS = '{MAP_DISPLAY}' === 'block';

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã®éè¡¨ç¤º
        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.classList.remove('active');
            }
        }

        // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼å‡¦ç†
        function handleImageError() {
            hideLoading();
            const imagePane = document.getElementById('imagePane');
            imagePane.innerHTML = '<div class="no-gps-message"><div class="icon">âš ï¸</div><p>ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</p></div>';
        }

        // åœ°å›³ã®åˆæœŸåŒ–ï¼ˆGPS ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
        if (HAS_GPS && typeof L !== 'undefined') {
            try {
                const map = L.map('map').setView([LAT, LON], 13);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19,
                    minZoom: 1
                }).addTo(map);

                // ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
                const marker = L.marker([LAT, LON]).addTo(map);
                marker.bindPopup('<b>æ’®å½±å ´æ‰€</b><br>ç·¯åº¦: ' + LAT.toFixed(6) + '<br>çµŒåº¦: ' + LON.toFixed(6));

                // ãƒãƒƒãƒ—ã®ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
                window.addEventListener('resize', () => {
                    setTimeout(() => {
                        map.invalidateSize();
                    }, 100);
                });

                // ã‚¹ãƒ—ãƒªãƒƒã‚¿ãƒ¼ã®ãƒ‰ãƒ©ãƒƒã‚°å‡¦ç†
                const splitter = document.getElementById('splitter');
                const imagePane = document.getElementById('imagePane');
                const container = document.querySelector('.split-container');
                let isDragging = false;
                let startY = 0;
                let startHeight = 0;

                splitter.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    startY = e.clientY;
                    startHeight = imagePane.getBoundingClientRect().height;
                    e.preventDefault();
                    document.body.style.cursor = 'ns-resize';
                    document.body.style.userSelect = 'none';
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;

                    const containerRect = container.getBoundingClientRect();
                    const deltaY = e.clientY - startY;
                    const newHeight = startHeight + deltaY;
                    const percentage = (newHeight / containerRect.height) * 100;

                    // æœ€å°/æœ€å¤§ã‚µã‚¤ã‚ºã®åˆ¶é™ï¼ˆ10% ã€œ 90%ï¼‰
                    if (percentage >= 10 && percentage <= 90) {
                        imagePane.style.flex = `0 0 ${percentage}%`;

                        // åœ°å›³ã®ãƒªã‚µã‚¤ã‚ºã‚’å³åº§ã«åæ˜ 
                        setTimeout(() => {
                            map.invalidateSize();
                        }, 0);
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        document.body.style.cursor = '';
                        document.body.style.userSelect = '';

                        // æœ€çµ‚çš„ãªãƒãƒƒãƒ—ãƒªã‚µã‚¤ã‚º
                        setTimeout(() => {
                            map.invalidateSize();
                        }, 100);
                    }
                });

                // åˆæœŸãƒãƒƒãƒ—ã‚µã‚¤ã‚ºã®èª¿æ•´
                setTimeout(() => {
                    map.invalidateSize();
                }, 200);

            } catch (error) {
                console.error('åœ°å›³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            }
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹ï¼ˆè¦ªã«é€šçŸ¥ï¼‰
                window.close();
            }
        });
    </script>
</body>
</html>
